<!DOCTYPE html>
<html xmlns:th="https://thymeleaf.org">
<head>
	<meta charset="UTF-8" name="viewport" content="width=device-width, shrink-to-fit=no">
	<title>BLAZING - Team Elm</title>
	<!-- jquery -->
	<script type="application/javascript" th:src="@{https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js}"></script>
	<!-- slick.js -->
	<link rel="stylesheet" type="text/css" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css}">
	<script type="application/javascript" th:src="@{https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js}"></script>
	<link rel="stylesheet" type="text/css" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css}">
	<!-- popper.js -->
	<script type="application/javascript" th:src="@{https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js}"></script>
	<!-- bootstrap -->
	<link rel="stylesheet" type="text/css" th:href="@{https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css}">
	<script type="application/javascript" th:src="@{https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js}"></script>
	<!-- source sans pro -->
	<link th:href='@{https://fonts.googleapis.com/css?family=Source+Sans+Pro}' rel='stylesheet' type='text/css'>
	<!-- font awesome -->
	<link th:href="@{https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css}" rel="stylesheet" type="text/css">
</head>

<link rel="stylesheet" href="/css/styles.css">

<body class="bg-dark">
	<header th:insert="/fragments/header.html :: header"></header>
	<div class="container">
		<div class="row">
			<div class="col">
				<section>
					<h5 class="section-header">SETTINGS</h5>
					<h3 class="ml-2" th:text="|${session.currentUser.firstName} ${session.currentUser.lastName}|">first and last name</h3>
					<form class="p-2 border mb-2">
						<h5>Change Profile</h5>
						<div class="form-group">
						</div>
						<!-- <div class="form-group">
							<label for="change-first">Change First Name</label>
							<input type="text" class="form-control" id="change-first" aria-describedby="change-first">
						</div>
						<div class="form-group">
							<label for="change-last">Change Last Name</label>
							<input type="text" class="form-control" id="change-last" aria-describedby="change-last">
						</div> -->
						<div class="form-group">
							<label for="change-email">Change Email</label>
							<input type="text" class="form-control" id="change-email" aria-describedby="change-email" th:placeholder="${session.currentUser.emailAddress}">
							<small class="text-danger" id="no-em-change" style="display: none;">Please enter your email</small>
							<small class="text-danger" id="inv-em-change" style="display: none;">Invalid email</small>
						</div>
						<!-- <div class="form-group">
							<label for="change-info">Update User Info</label>
							<textarea class="form-control" id="change-info" rows="5" style="resize: none;"></textarea>
						</div> -->
						<button class="btn btn-secondary" id="update-user-button">Update User Info</button>
					</form>
					<div class="modal fade" id="nemail-reverify" tabindex="-1" role="dialog" aria-labelledby="#reverifyLabel" aria-hidden="true">
						<div class="modal-dialog modal-dialog-centered" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="reverifyLabel">Success!</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="location.reload()">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">
									You have successfully changed your email. 
									We have sent a verification email to you. 
									Please check your new email.
								</div>
							</div>
						</div>
					</div>
					<script>
					$(function(){
						$("#update-user-button").on("click",function(e){
							e.preventDefault();
							$("#no-em-change").hide();
							$("#inv-em-change").hide();
							$("#update-user-button").css("background-color","#aaaaaa");
							$("#update-user-button").attr("disabled",true);
							var newEmail = $("#change-email").val();
							var fail = false;
							if (newEmail.length == 0){
								$("#no-em-change").show();
								fail = true;
							}
							if (newEmail.match(emailRegex) == null && newEmail.length != 0){
								$("#inv-em-change").show();
								fail = true;
							}
							if (fail){
								$("#update-user-button").css("background-color","#6c757d");
								$("#update-user-button").attr("disabled",false);
								return;
							}
							var url = location.href.substr(0, location.href.lastIndexOf("/"));
							$.ajax({
								type : "POST",
								contentType : "application/json",
								url : url+"/changeemail",
								data : ""+newEmail,
								success : function(data) {
									if (data == true){
										$("#change-email").val("");
									}else{
										$("#inv-em-change").show();
									}
								},
								error : function(e) {
									console.log("ERROR: ", e);
								},
								complete : function() {
									$("#update-user-button").css("background-color","#6c757d");
									$("#update-user-button").attr("disabled",false);
									$("#nemail-reverify").modal("show");
								}
							});
						});
					});
					</script>
					
					<form class="p-2 border">
						<h5>Change Password</h5>
						<div class="form-group">
							<label for="enter-current-pw">Enter Current Password</label>
							<input type="password" class="form-control" id="enter-cur-pw" aria-describedby="enter-current-pw">
							<small class="text-danger" id="no-curpw-change" style="display: none;">Please enter your current password</small>
						</div>
						<div class="form-group">
							<label for="enter-new-pw">Enter New Password</label>
							<input type="password" class="form-control" id="enter-new-pw" aria-describedby="enter-new-pw">
							<small class="text-danger" id="no-newpw-change" style="display: none;">Please enter your new password</small>
						</div>
						<div class="form-group">
							<label for="reenter-new-pw">Re-enter New Password</label>
							<input type="password" class="form-control" id="reenter-new-pw" aria-describedby="reenter-new-pw">
							<small class="text-danger" id="no-renewpw-change" style="display: none;">Please enter your password</small>
						</div>
						<button class="btn btn-secondary" id="update-pw-button">Update Password</button>
						<small class="text-danger" id="fail-pw-change" style="display: none;">Fail, try again</small>
					</form>
					<script>
					$(function(){
						$("#update-pw-button").on("click",function(e){
							e.preventDefault();
							$("#no-curpw-change").hide();
							$("#no-newpw-change").hide();
							$("#no-renewpw-change").hide();
							$("#fail-pw-change").hide();
							$("#update-pw-button").css("background-color","#aaaaaa");
							$("#update-pw-button").attr("disabled",true);
							var curPass = $("#enter-cur-pw").val();
							var newPass = $("#enter-new-pw").val();
							var renewPass = $("#reenter-new-pw").val();
							var fail = false;
							if (curPass.length == 0){
								$("#no-curpw-change").show();
								fail = true;
							}
							if (newPass.length == 0){
								$("#no-newpw-change").show();
								fail = true;
							}
							if (renewPass.length == 0){
								$("#no-renewpw-change").show();
								fail = true;
							}
							if (fail){
								$("#update-user-button").css("background-color","#6c757d");
								$("#update-user-button").attr("disabled",false);
								return;
							}
							var passwords = {};
							passwords["oldPass"] = curPass;
							passwords["newPass"] = newPass;
							passwords["confirmNewPass"] = renewPass;
							var url = location.href.substr(0, location.href.lastIndexOf("/"));
							var jsonString = JSON.stringify(passwords);
							$.ajax({
								type : "POST",
								contentType : "application/json",
								url : url+"/changepass",
								data : jsonString,
								success : function(data) {
									if (data == true){
										$("#enter-cur-pw").val("");
										$("#enter-new-pw").val("");
										$("#reenter-new-pw").val("");
									}else{
										$("#fail-pw-change").show();
									}
								},
								error : function(e) {
									console.log("ERROR: ", e);
								},
								complete : function() {
									$("#update-pw-button").css("background-color","#6c757d");
									$("#update-pw-button").attr("disabled",false);
								}
							});
						});
					});
					</script>
				</section>
			</div>
		</div>
	</div>
	<footer th:insert="/fragments/footer.html :: footer"></footer>
</body>

<script type="application/javascript" th:src="@{/js/properties.js}"></script>
<script type="application/javascript" th:src="@{/js/main.js}"></script>
<script type="application/javascript" th:src="@{/js/add-media.js}"></script>

</html>